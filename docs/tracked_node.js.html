<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>tracked_node.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Address.html">Address</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Address.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="Address.html#.fromHeximal">fromHeximal</a></li></ul></li><li><a href="BigUInt.html">BigUInt</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BigUInt.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="BigUInt.html#.fromHeximal">fromHeximal</a></li><li data-type='method' style='display: none;'><a href="BigUInt.html#toHeximal">toHeximal</a></li></ul></li><li><a href="Block.html">Block</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Block.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="Block.html#.fromRpcResult">fromRpcResult</a></li></ul></li><li><a href="BlockHash.html">BlockHash</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BlockHash.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="BlockHash.html#.fromHeximal">fromHeximal</a></li></ul></li><li><a href="ByteArray.html">ByteArray</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ByteArray.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="ByteArray.html#.fromBadHeximal">fromBadHeximal</a></li><li data-type='method' style='display: none;'><a href="ByteArray.html#.fromHeximal">fromHeximal</a></li></ul></li><li><a href="Client.html">Client</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Client.html#getLogs">getLogs</a></li></ul></li><li><a href="ClientLayer1.html">ClientLayer1</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ClientLayer1.html#getLogs">getLogs</a></li></ul></li><li><a href="ClientLayer2.html">ClientLayer2</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ClientLayer2.html#getLogs">getLogs</a></li></ul></li><li><a href="ClientLayer3.html">ClientLayer3</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ClientLayer3.html#getLogs">getLogs</a></li></ul></li><li><a href="DataError.html">DataError</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DataError.html#.throw">throw</a></li></ul></li><li><a href="EndpointQuota.html">EndpointQuota</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EndpointQuota.html#.assertInstance">assertInstance</a></li></ul></li><li><a href="Gateway.html">Gateway</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Gateway.html#pick">pick</a></li></ul></li><li><a href="HttpEndpoint.html">HttpEndpoint</a><ul class='methods'><li data-type='method' style='display: none;'><a href="HttpEndpoint.html#.assertInstance">assertInstance</a></li></ul></li><li><a href="HttpUrl.html">HttpUrl</a><ul class='methods'><li data-type='method' style='display: none;'><a href="HttpUrl.html#.assertInstance">assertInstance</a></li></ul></li><li><a href="Log.html">Log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Log.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="Log.html#.fromRpcResult">fromRpcResult</a></li></ul></li><li><a href="LogFilter.html">LogFilter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LogFilter.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="LogFilter.html#toRpcInput">toRpcInput</a></li></ul></li><li><a href="LogSegment.html">LogSegment</a></li><li><a href="LogTopic.html">LogTopic</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LogTopic.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="LogTopic.html#.fromHeximal">fromHeximal</a></li><li data-type='method' style='display: none;'><a href="LogTopic.html#toHeximal">toHeximal</a></li></ul></li><li><a href="LogTopicCombination.html">LogTopicCombination</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LogTopicCombination.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="LogTopicCombination.html#.fromRpcResult">fromRpcResult</a></li></ul></li><li><a href="LogTopicFilter.html">LogTopicFilter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LogTopicFilter.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="LogTopicFilter.html#toRpcInput">toRpcInput</a></li></ul></li><li><a href="Node.html">Node</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Node.html#getBlockByNumber">getBlockByNumber</a></li><li data-type='method' style='display: none;'><a href="Node.html#getBlockNumber">getBlockNumber</a></li><li data-type='method' style='display: none;'><a href="Node.html#getLogs">getLogs</a></li><li data-type='method' style='display: none;'><a href="Node.html#getTransactionByHash">getTransactionByHash</a></li></ul></li><li><a href="NotExistedError.html">NotExistedError</a></li><li><a href="ProtocolError.html">ProtocolError</a></li><li><a href="ResourceLocker.html">ResourceLocker</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ResourceLocker.html#assertConsumption">assertConsumption</a></li><li data-type='method' style='display: none;'><a href="ResourceLocker.html#lockFor">lockFor</a></li></ul></li><li><a href="Timestamp.html">Timestamp</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Timestamp.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="Timestamp.html#.fromHeximal">fromHeximal</a></li></ul></li><li><a href="TrackedNode.html">TrackedNode</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TrackedNode.html#getBlockByNumber">getBlockByNumber</a></li><li data-type='method' style='display: none;'><a href="TrackedNode.html#getBlockNumber">getBlockNumber</a></li><li data-type='method' style='display: none;'><a href="TrackedNode.html#getLogs">getLogs</a></li><li data-type='method' style='display: none;'><a href="TrackedNode.html#getTransactionByHash">getTransactionByHash</a></li></ul></li><li><a href="Transaction.html">Transaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Transaction.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="Transaction.html#.fromRpcResult">fromRpcResult</a></li></ul></li><li><a href="TransactionHash.html">TransactionHash</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TransactionHash.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="TransactionHash.html#.fromHeximal">fromHeximal</a></li><li data-type='method' style='display: none;'><a href="TransactionHash.html#toHeximal">toHeximal</a></li></ul></li><li><a href="UInt.html">UInt</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UInt.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="UInt.html#.fromHeximal">fromHeximal</a></li></ul></li><li><a href="UInt16.html">UInt16</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UInt16.html#.assertInstance">assertInstance</a></li><li data-type='method' style='display: none;'><a href="UInt16.html#.fromHeximal">fromHeximal</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#assertArray">assertArray</a></li><li><a href="global.html#assertConfigObject">assertConfigObject</a></li><li><a href="global.html#assertObject">assertObject</a></li><li><a href="global.html#assertOptionalString">assertOptionalString</a></li><li><a href="global.html#getUnkownAttribute">getUnkownAttribute</a></li><li><a href="global.html#Heximal">Heximal</a></li><li><a href="global.html#heximalToBigInt">heximalToBigInt</a></li><li><a href="global.html#heximalToBuffer">heximalToBuffer</a></li><li><a href="global.html#heximalToNumber">heximalToNumber</a></li><li><a href="global.html#isAbi">isAbi</a></li><li><a href="global.html#isEthAddressHeximal">isEthAddressHeximal</a></li><li><a href="global.html#isHeximal">isHeximal</a></li><li><a href="global.html#isPositiveInteger">isPositiveInteger</a></li><li><a href="global.html#isTransactionHashHeximal">isTransactionHashHeximal</a></li><li><a href="global.html#isUint">isUint</a></li><li><a href="global.html#isUnsignedInteger">isUnsignedInteger</a></li><li><a href="global.html#isValidEndpoint">isValidEndpoint</a></li><li><a href="global.html#isValidHttpUrl">isValidHttpUrl</a></li><li><a href="global.html#numberToHeximal">numberToHeximal</a></li><li><a href="global.html#uIntToHeximal">uIntToHeximal</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">tracked_node.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const {ProtocolError, Node} = require('./node')
const {
    DataError,
    NotExistedError,
    UInt,
    BigUInt,
    HttpEndpoint,
    EndpointQuota,
    Block,
    LogFilter,
    Log,
    LogSegment,
    TransactionHash,
    Transaction,
    assertConfigObject
} = require('./type')

class NoResourceError extends Error {
    constructor(message) {
        super(message)
        this.name = message
    }
}

/**
 * Ensure a lock for resource, base on timestamp and quantity.
 */
 class ResourceLocker {
    /**
     *
     * @param {object} config
     * @param {EndpointQuota} config.quota
     */
    constructor(config) {
        assertConfigObject(config, 'config', ['quota'])
        let {quota} = config
        EndpointQuota.assertInstance(quota, 'cofig.quota')
        this._quota = quota
        this._remainQuantity = this._quota.batchLimit.value
        this._nextFillTimestamp = Date.now() + this._quota.batchTimespan.value
        this._lockToTimestamp = undefined
    }

    /**
     * Ensure resource is available and there is enough quantity. If calling
     * successfully then resource is reduce by `quantity`.
     *
     * @param {UInt} quantity - Number of request for consumption.
     * @throws {NoResourceError}
     */
    assertConsumption(quantity) {
        UInt.assertInstance(quantity, 'quantity')
        let now = Date.now()
        if (this._lockToTimestamp &amp;&amp; now &lt; this._lockToTimestamp) {
            throw new NoResourceError('locked by timestamp')
        }
        if (now >= this._nextFillTimestamp) {
            this._remainQuantity = this._quota.batchLimit.value
            this._nextFillTimestamp = Date.now() +
                this._quota.batchTimespan.value
        }
        let remain = this._remainQuantity - quantity.value
        if (remain &lt; 0) {
            throw new NoResourceError('no quota')
        }
        this._remainQuantity = remain
    }

    /**
     * Lock in time range [now, now + timespan]. If there is already lock then
     * override it. This call locks resource even resource quantity is available.
     *
     * @param {UInt} timespan - Time period in miliseconds.
     */
    lockFor(timespan) {
        this._lockToTimestamp = Date.now() + timespan
    }
}

/**
 * Improvement of `Node` without modifications of lower layers of ETH JSON RPC.
 *
 * Firstly, it handles overloading by recognize errors and reduce number of
 * requests or even denie callings in nextime.
 *
 * Secondly, it try to avoid or at least reduce incorrect returned data from RPC
 * methods such as `eth_getLogs`.
 */
class TrackedNode {
    /**
     *
     * @param {object} config
     * @param {HttpEndpoint} config.endpoint
     * @param {EndpointQuota} config.quota
     * @param {UInt} [config.timeout]
     * @param {BigUInt} [config.blockGap]
     * @throws {DataError}
     */
    constructor(config) {
        assertConfigObject(config, 'config', ['endpoint', 'timeout', 'quota'])
        let {endpoint, quota, timeout, blockGap} = config
        HttpEndpoint.assertInstance(endpoint, 'config.endpoint')
        EndpointQuota.assertInstance(quota, 'config.quota')
        timeout = timeout || new UInt(3000)
        UInt.assertInstance(timeout, 'config.timeout')
        blockGap = blockGap || new BigUInt(15)
        BigUInt.assertInstance(blockGap, 'config.blockGap')
        this._blockGap = blockGap
        this._node = new Node({endpoint, timeout})
        this._locker = new ResourceLocker({quota: quota})
    }

    /**
     * @type {boolean}
     */
    get isAvailable() {}

    /**
     * @returns {BigUInt}
     * @throws {NoResourceError | ProtocolError}
     */
    async getBlockNumber() {
        this._locker.assertConsumption(1)
        try {
            return await this._node.getBlockNumber()
        }
        catch (error) {
            this._handleNodeError(error)
        }
    }

    /**
     * @param {BigUInt} blockNumber
     * @returns {Block}
     * @throws {DataError | NoResourceError | NotExistedError | ProtocolError}
     */
    async getBlockByNumber(blockNumber) {
        this._locker.assertConsumption(1)
        try {
            return await this._node.getBlockByNumber(blockNumber)
        }
        catch (error) {
            this._handleNodeError(error)
        }
    }

    /**
     *
     * @param {LogFilter} filter
     * @returns {Array&lt;LogSegment>}
     * @throws {DataError | NoResourceError | ProtocolError}
     */
    async getLogs(filter) {
        this._locker.assertConsumption(
            new UInt(2)
        )
        try {
            let blockNumber = await this._node.getBlockNumber()
            let safeBlockNumber = blockNumber.value - this._blockGap.value
            if (safeBlockNumber &lt; filter.fromBlock.value) {
                this._locker.lockFor(30000)
                return
            }
            let toBlock = filter.toBlock.value &lt; safeBlockNumber
                ? filter.toBlock
                : new BigUInt(safeBlockNumber)
            let safeFilter = new LogFilter({
                fromBlock: filter.fromBlock,
                toBlock: toBlock,
                addresses: filter.addresses,
                topics: filter.topics
            })
            let logs = await this._node.getLogs(safeFilter)
            return new LogSegment(logs, toBlock)
        }
        catch (error) {
            this._handleNodeError(error)
        }
    }

    /**
     *
     * @param {TransactionHash} hash
     * @returns {Transaction}
     * @throws {DataError | NoResourceError | NotExistedError | ProtocolError}
     */
    async getTransactionByHash(hash) {
        this._locker.assertConsumption(1)
        try {
            return await this._node.getTransactionByHash(hash)
        }
        catch (error) {
            this._handleNodeError(error)
        }
    }

    /**
     * @private
     * @param {DataError | NotExistedError | ProtocolError} error - Error which
     * is throws from `Node`.
     * @throws {DataError | NotExistedError | ProtocolError}
     */
    _handleNodeError(error) {
        if (error instanceof ProtocolError) {
            this._handleProtocolError(error)
        }
        else {
            throw error
        }
    }

    /**
     * @private
     * @param {ProtocolError} error
     * @throws {ProtocolError} - Error which must be fixed.
     */
    _handleProtocolError(error) {
        switch (error.code) {
            case ProtocolError.CODE_IMPLICIT_OVERLOAD:
                this._locker.lockFor(3000)
            case ProtocolError.CODE_EXPLICIT_OVERLOAD:
                this._locker.lockFor(6000)
            case ProtocolError.CODE_BAD_SERVER:
                this._locker.lockFor(60000)
            case ProtocolError.CODE_BAD_RESPONSE:
                this._locker.lockFor(60000)
            case ProtocolError.CODE_BAD_REQUEST:
                throw error
        }
    }
}

module.exports = {
    NoResourceError,
    TrackedNode
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Jan 07 2022 02:47:25 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
